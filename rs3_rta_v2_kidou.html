<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>RTA本体レイアウト（v2起動・統合版）</title>

  <!-- 本体レイアウトCSS -->
  <link rel="stylesheet" href="rs3_rta_v2_kidou.css">

  <!-- ミニブロックCSS -->
  <link rel="stylesheet" href="rs3_box_char_v2.css">
  <link rel="stylesheet" href="rs3_box_spark_v2.css">
  <link rel="stylesheet" href="rs3_box_fm_v2.css">
  <link rel="stylesheet" href="rs3_box_tlist_v2.css">
  <link rel="stylesheet" href="rs3_box_bunshin_pat_v2.css">
  <link rel="stylesheet" href="rs3_box_fb_v2.css">
  <link rel="stylesheet" href="rs3_box_hakai_v2.css">
</head>
<body>

  <!--
    開発メモ：
    ・class="layout-hp-normal" : HP>0（通常モード）
    ・class="layout-hp-zero"   : HP<=0（HP0モード）
    を body 直下の #rta-v2-root に付け替えて表示を確認してください。
  -->
  <div id="rta-v2-root" class="layout-hp-normal">

    <!-- 上段：左（メイン＋サブ）＋右 -->
    <div class="rta-v2-top-row">

      <!-- 左列：メイン＋サブ -->
      <div class="rta-v2-top-left">

        <!-- 左上メイン：キャラ＋お供レベル -->
        <div id="rta-v2-top-lm"></div>

        <!-- 左上サブ：SPARK / FORMATION（HP状態で切替） -->
        <div id="rta-v2-top-ls">
          <!-- HP>0：分身剣閃きブロック -->
          <div class="rta-v2-inner-block block-spark">
            <table class="spark-outer">
                  <thead>
                    <tr>
                      <th colspan="3" class="spark-title">
                        分身剣閃き確率
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <!-- 本体は colspan=3 の中に内部テーブルを持つ -->
                      <td colspan="3" class="spark-container-cell">
                        <table class="spark-inner">
                          <tbody>
                            <!-- 対フォル：2行（王冠 有／王冠 無） -->
                            <tr>
                              <td class="spark-label" rowspan="2">対フォル</td>
                              <td class="spark-row" rowspan="2">
                                閃き回数
                                <span class="spin-box">
                                  <input
                                    type="number"
                                    class="num-input spark-count-input"
                                    id="spark-count-forneus"
                                    min="0"
                                    max="8"
                                    value="0"
                                    step="1"
                                    aria-label="対フォルの閃き回数">
                                  <div class="spin-buttons">
                                    <button type="button" class="spin-btn spin-up">▲</button>
                                    <button type="button" class="spin-btn spin-down">▼</button>
                                  </div>
                                </span>
                              </td>
                              <td class="spark-row">
                                <span class="spark-crown-label">王冠 有</span>
                                <span class="spark-rate" id="spark-rate-forneus-crown">0.00%</span>
                              </td>
                            </tr>
                            <tr>
                              <td class="spark-row">
                                <span class="spark-crown-label">王冠 無</span>
                                <span class="spark-rate" id="spark-rate-forneus-nocrown">0.00%</span>
                              </td>
                            </tr>

                            <!-- 対ビュネ：1行（王冠 無 のみ） -->
                            <tr>
                              <td class="spark-label">対ビュネ</td>
                              <td class="spark-row">
                                閃き回数
                                <span class="spin-box">
                                  <input
                                    type="number"
                                    class="num-input spark-count-input"
                                    id="spark-count-byunei"
                                    min="0"
                                    max="8"
                                    value="0"
                                    step="1"
                                    aria-label="対ビュネの閃き回数">
                                  <div class="spin-buttons">
                                    <button type="button" class="spin-btn spin-up">▲</button>
                                    <button type="button" class="spin-btn spin-down">▼</button>
                                  </div>
                                </span>
                              </td>
                              <td class="spark-row">
                                <span class="spark-crown-label">王冠 無</span>
                                <span class="spark-rate" id="spark-rate-byunei-nocrown">0.00%</span>
                              </td>
                            </tr>

                          </tbody>
                        </table>
                      </td>
                    </tr>
                  </tbody>
                </table>
          </div>

          <!-- HP<=0：陣形スロットブロック -->
          <div class="rta-v2-inner-block block-formation">
            <div class="formation-block">
                  <div class="formation-title">陣形配置</div>

                  <div class="formation-grid">
              <!-- 上から ④ → ② → ① → ③ → ⑤ のくの字配置 -->

              <!-- ④：一番上・右寄せ -->
              <div class="formation-cell formation-cell-4">
                <span class="formation-label">④</span>
                <select id="formation-slot-4" class="formation-select">
                  <option value="">キャラ名</option>
                </select>
              </div>

              <!-- ②：上から2つ目・やや右寄せ -->
              <div class="formation-cell formation-cell-2">
                <span class="formation-label">②</span>
                <select id="formation-slot-2" class="formation-select">
                  <option value="">キャラ名</option>
                </select>
              </div>

              <!-- ①：中央・左寄せ -->
              <div class="formation-cell formation-cell-1">
                <span class="formation-label">①</span>
                <select id="formation-slot-1" class="formation-select">
                  <option value="">キャラ名</option>
                </select>
              </div>

              <!-- ③：下から2つ目・やや右寄せ -->
              <div class="formation-cell formation-cell-3">
                <span class="formation-label">③</span>
                <select id="formation-slot-3" class="formation-select">
                  <option value="">キャラ名</option>
                </select>
              </div>

              <!-- ⑤：一番下・右寄せ -->
              <div class="formation-cell formation-cell-5">
                <span class="formation-label">⑤</span>
                <select id="formation-slot-5" class="formation-select">
                  <option value="">キャラ名</option>
                </select>
              </div>
            </div>


                </div>
          </div>
        </div>

      </div><!-- /.rta-v2-top-left -->

      <!-- 右上：技リスト or 分身DMG＋形態X -->
      <div id="rta-v2-top-right"></div>


    </div><!-- /.rta-v2-top-row -->

    <!-- 下段：フォル＆ビュネHP or 破壊ツール下段 -->
    <div id="rta-v2-bottom">

      <!-- HP>0：フォル＆ビュネHP -->
      <div class="rta-v2-inner-block block-fb-hp">
        <div id="boss-fb-area">
              <div class="boss-wrapper">

                <!-- フォル -->
                <div class="boss-box" id="boss-forneus">
                  <div class="boss-title">
                    フォル
                    <span class="otomo-label">
                      お供レベル：<span id="forneus-otomo-level-display">0</span>
                    </span>
                  </div>

		  <div class="boss-row-text">
  		    最大HP:
 		    <span class="boss-hp-static" id="forneus-max-hp">28000</span>
		    <!-- 見えないダミーボタン（56×23のスペース確保用） -->
 		    <button
   		      type="button"
	   	      class="boss-btn boss-btn-space"
 		      aria-hidden="true"
  		      tabindex="-1"></button>
		    <button type="button" class="boss-btn" id="forneus-return">リターン</button>
		  </div>


                  <div class="boss-row-text">
                    <label>ダメージ入力：
                      <input type="text"
                             id="forneus-damage"
                             class="boss-dmg-input"
                             inputmode="numeric"
                             pattern="[0-9]*"
                             value="">
                    </label>
                  </div>

                  <div class="boss-remaining">
                    残りHP:
                    <span id="forneus-remaining" class="boss-remaining-value">28000</span>
                    <span class="boss-last-damage-label">直前<br>ダメージ:</span>
                    <span id="forneus-last-damage" class="boss-last-damage-value">0000</span>
                  </div>
                </div>

                <!-- ビュネ -->
                <div class="boss-box" id="boss-byunei">
                  <div class="boss-title">
                    ビュネ
                    <span class="otomo-label">
                      お供レベル：<span id="byunei-otomo-level-display">0</span>
                    </span>
                  </div>
		<div class="boss-row-text">
		  最大HP:
		  <span class="boss-hp-static" id="byunei-max-hp">9000</span>
		  <!-- 見えないダミーボタン（56×23のスペース確保用） -->
		  <button
		    type="button"
		    class="boss-btn boss-btn-space"
		    aria-hidden="true"
		    tabindex="-1"></button>
		  <button type="button" class="boss-btn" id="byunei-return">リターン</button>
		</div>


                  <div class="boss-row-text">
                    <label>ダメージ入力：
                      <input type="text"
                             id="byunei-damage"
                             class="boss-dmg-input"
                             inputmode="numeric"
                             pattern="[0-9]*"
                             value="">
                    </label>
                  </div>

                  <div class="boss-remaining">
                    残りHP:
                    <span id="byunei-remaining" class="boss-remaining-value">9000</span>
                    <span class="boss-last-damage-label">直前<br>ダメージ:</span>
                    <span id="byunei-last-damage" class="boss-last-damage-value">0000</span>
                  </div>
                </div>

              </div><!-- /.boss-wrapper -->
            </div><!-- /#boss-fb-area -->
      </div>

      <!-- HP<=0：破壊ツール下段 -->
      <div class="rta-v2-inner-block block-hakai-bottom">
        <div id="hakai-bottom-root"></div>
      </div>
    </div>

  </div><!-- /#rta-v2-root -->
  <script src="char_slot.js"></script>
  <script src="rs3chrparam.js"></script>
  <script src="rs3_rta_v2_char_param.js"></script>
  <script src="right_tec.js"></script>
  <script src="bunshin_sword_99.js"></script>
  <script src="rs3_box_bunshin_pat_v2.js"></script>
  <script src="rs3_box_fb_v2.js"></script>
  <script src="rs3_rta_v2_bunshin_link.js"></script>
  <script src="rs3_box_spark_v2.js"></script>
  <script src="rs3_box_hakai_v2.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      if (typeof initCharSlotBox === "function") {
        initCharSlotBox("rta-v2-top-lm");
      }

      // DOM構築 → キャラスロットHTML生成 → RS3_CHAR_DATA 初期化の順序を保証
      if (window.rs3_rta_v2_char_module &&
          typeof window.rs3_rta_v2_char_module.init === "function") {
        window.rs3_rta_v2_char_module.init();
      }

      if (window.rs3_rta_v2_bunshin_link &&
          typeof window.rs3_rta_v2_bunshin_link.init === "function") {
        window.rs3_rta_v2_bunshin_link.init();
      }

      if (window.rs3_box_hakai_v2 &&
          typeof window.rs3_box_hakai_v2.init === "function") {
        window.rs3_box_hakai_v2.init();
      }
      // ------------------------------------------------------
      // お供用リセットボタン：「起動直後の状態」に戻す
      // ------------------------------------------------------
      const resetBtn = document.querySelector(
        "#rta-v2-top-lm > div > table > tbody > " +
        "tr.rta-v2-char-row-otomo-header > " +
        "td.support-reset-header > button"
      );

      if (resetBtn) {
        resetBtn.addEventListener("click", function () {
          // 「rs3_rta_v2_kidou.html」を開いた直後の状態に戻す
          location.reload();
        });
      }

      // ------------------------------------------------------
      // お供レベル & フォル／ビュネHP連動
      // ------------------------------------------------------
      const supportCharSelect = document.getElementById("support-char");
      const supportHpInput    = document.getElementById("support-hp");
      const supportLvSpan     = document.getElementById("support-lv");
      const forneusLvSpan     = document.getElementById("forneus-otomo-level-display");
      const byuneiLvSpan      = document.getElementById("byunei-otomo-level-display");

      // お供周りの要素が無ければ、ここから先は何もしない
      if (!supportHpInput || !supportLvSpan) {
        return;
      }

      // ハーマン／タチアナの「デフォルトHP」
      const BASE_SUPPORT_HP = {
        herman: 210,
        tatiana: 65
      };

      function getCurrentSupportKey() {
        if (!supportCharSelect) return "herman";
        const v = supportCharSelect.value;
        if (v === "tatiana") return "tatiana";
        return "herman"; // デフォルトはハーマン扱い
      }

      function getBaseSupportHp() {
        const key = getCurrentSupportKey();
        return BASE_SUPPORT_HP[key] || 0;
      }

      // 差分 / 15 を使って お供LV を算出
      function calcOtomoLevel(currentHp, baseHp) {
        const diff = currentHp - baseHp;
        if (!Number.isFinite(diff) || diff <= 0) return 0;
        return Math.max(0, Math.floor(diff / 15));
      }

      // お供HP → お供LV → フォル／ビュネHP を反映
      function applyOtomoLevel() {
        const baseHp = getBaseSupportHp();
        if (baseHp <= 0) {
          // 基礎値がおかしい場合は全部 0 扱い
          supportLvSpan.textContent = "0";
          if (forneusLvSpan) forneusLvSpan.textContent = "0";
          if (byuneiLvSpan)  byuneiLvSpan.textContent  = "0";
          return;
        }

        let currentHp = Number(supportHpInput.value);
        if (!Number.isFinite(currentHp) || currentHp <= 0) {
          currentHp = baseHp;
        }

        // 「デフォルト値より小さくならない」制約
        if (currentHp < baseHp) {
          currentHp = baseHp;
          supportHpInput.value = String(baseHp);
        }

        const otomoLv = calcOtomoLevel(currentHp, baseHp);

        // 上部「お供LV」
        supportLvSpan.textContent = String(otomoLv);

        // 下部フォル／ビュネ側の「お供LV 表示」
        if (forneusLvSpan) forneusLvSpan.textContent = String(otomoLv);
        if (byuneiLvSpan)  byuneiLvSpan.textContent  = String(otomoLv);

        // フォル／ビュネの最大HP更新
        if (window.rs3_box_fb_v2) {
          const forneusBase = 28000;
          const byuneiBase  = 9000;

          // 基礎HP + (基礎HP / 32) * お供LV を小数点以下切り捨て
          const forneusHp = Math.floor(forneusBase + (forneusBase / 32) * otomoLv);
          const byuneiHp  = Math.floor(byuneiBase  + (byuneiBase  / 32) * otomoLv);

          if (typeof window.rs3_box_fb_v2.setForneusMaxHP === "function") {
            window.rs3_box_fb_v2.setForneusMaxHP(forneusHp);
          }
          if (typeof window.rs3_box_fb_v2.setByuneiMaxHP === "function") {
            window.rs3_box_fb_v2.setByuneiMaxHP(byuneiHp);
          }
        }
      }

      // お供HPのスピン＆直接入力で反映
      supportHpInput.addEventListener("input",  applyOtomoLevel);
      supportHpInput.addEventListener("change", applyOtomoLevel);

      // お供キャラ（ハーマン／タチアナ）変更時も再計算
      if (supportCharSelect) {
        supportCharSelect.addEventListener("change", function () {
          // rs3_rta_v2_char_param.js 側で基礎HPを書き換えた後に反映したいので、少し後ろにずらす
          setTimeout(applyOtomoLevel, 0);
        });
      }

      // 起動直後の表示を同期
      applyOtomoLevel();
    });
  </script>

</body>
</html>
